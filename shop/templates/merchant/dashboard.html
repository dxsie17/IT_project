{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>商家后台 - {{ store_name }}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/merchant_dashboard.css' %}">
</head>
<body>

    <!-- 顶部导航栏 -->
    <div class="navbar">
        <div class="store-info">{{ store_name }}</div>  <!-- 商家信息（左上角） -->
        <div class="nav-links">
            <a href="javascript:void(0);" class="tab active" onclick="switchTab('orders')">Orders</a>
            <a href="javascript:void(0);" class="tab" onclick="switchTab('items')">Item Catalog</a>
            <a href="javascript:void(0);" class="tab" onclick="switchTab('management')">Management</a>
        </div>
        <a href="{% url 'logout' %}" class="logout">登出</a>
    </div>

    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <a href="?status=Ongoing" class="{% if status_filter == 'Ongoing' %}active{% endif %}">Ongoing</a>
            <a href="?status=Finished" class="{% if status_filter == 'Finished' %}active{% endif %}">Finished</a>
            <a href="?status=Canceled" class="{% if status_filter == 'Canceled' %}active{% endif %}">Canceled</a>
        </div>

        <!-- 订单管理 -->
        <div id="orders" class="content tab-content active">
            {% if orders %}
                {% for order in orders %}
                <div class="order" id="order-{{ order.id }}">
                    <div class="order-header">No. {{ order.order_number }}</div>
                    {% for order_item in order.order_items.all %}
                    <div class="order-item">
                        <img src="{% if order_item.item.image %}{{ order_item.item.image.url }}{% else %}{% static 'img/1.jpeg' %}{% endif %}"
                             alt="{{ order_item.item.name }}">
                        <div>
                            <strong>{{ order_item.item.name }}</strong>
                        </div>
                        <div style="margin-left: auto; text-align: right;">
                            <p>£{{ order_item.item.price }} x {{ order_item.quantity }} = £{{ order_item.item.price|floatformat:2 }}</p>
                        </div>
                    </div>
                    {% endfor %}
                    <p style="text-align: right;"><strong>总价: £{{ order.total_price|floatformat:2 }}</strong></p>

                    <!-- 仅 Ongoing 订单显示操作按钮 -->
                    {% if order.status == "Ongoing" %}
                    <div class="order-actions">
                        {% if order.status == "Ongoing" %}
                            <button class="btn finish" onclick="updateOrderStatus({{ order.id }}, 'Finished')">完成</button>
                            <button class="btn cancel" onclick="updateOrderStatus({{ order.id }}, 'Canceled')">取消</button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p>暂无订单</p>
            {% endif %}
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function updateOrderStatus(orderId, newStatus) {
            fetch(`/merchant/orders/update/${orderId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `status=${encodeURIComponent(newStatus)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 获取订单元素
                    const orderElement = document.getElementById(`order-${orderId}`);
                    if (orderElement) {
                        orderElement.remove(); // 直接移除该订单
                    }
                } else {
                    alert("订单更新失败: " + data.error);
                }
            })
            .catch(error => console.error("请求失败:", error));
        }
    </script>

</body>
</html>